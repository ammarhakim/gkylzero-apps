#[ .................................................
#[
#[ Plot nodes of ASDEX 3x2v GK Gkeyll simulation
#[ on the poloidal plane.
#[
#[ Manaure Francisquez.
#[ November 2025.
#[
#[ .................................................

import numpy as np
import matplotlib.pyplot as plt
from matplotlib.collections import LineCollection
import postgkyl as pg
import scipy.interpolate 
from scipy.interpolate import RegularGridInterpolator

data_dir = "../input_file/" #[ Location of simulation data.
simName = 'gk_bgk_im_asdex_low_adapt_3x2v_p1' #[ Simulation name.

#[ Path to Gkeyll representation of poloidal flux (psi).
psid = pg.GData("../../../experiment/33341/Equilibria/Low_density/asdex_LSN_33341_1.775-psi.gkyl")

psisep = 0.0335734 #[ Separatrix psi. Results from gyrokinetic/unit/ctest_efit.c using 33341_1.775.eqdsk.
psi_min = 0.034 #[ Lower psi of Gkeyll simulation.
psi_max = 0.050 #[ Upper psi of Gkeyll simulation.
npsi = 6 #[ Number of psi contours to plot.

out_figure_file = False #[ Whether to write figure to a file.
out_figure_dir = "./" #[ Where to place figure if written.


#[ ............ END OF USER INPUTS (maybe) ............... ]#

# AUG first wall
R_wall = [1.532520534873825, 1.576411006950265, 1.6294889814444686, 1.6804715606504106, 1.7359672989387627, 1.7826301401658262, 
          1.8191222550321724, 1.849360420884321, 1.878502533816456, 1.9101107658186225, 1.9418479452231434, 1.9732788745470722, 
          2.007320988768681, 2.038848628644376, 2.069602584105943, 2.0965848280486385, 2.122535492772498, 2.1423611558845144, 
          2.163137806088896, 2.181109850292066, 2.194617090688708, 2.2025634743588087, 2.2066897912341554, 2.2071249887171023, 
          2.2026118296346917, 2.1944397880104702, 2.1840272852703384, 2.168924320769558, 2.149920697347552, 2.130304573764361, 
          2.1067233175587674, 2.0832710087555286, 2.055289422444585, 2.02745290196129, 1.9990522365926937, 1.9708449923276294, 
          1.9362709700713079, 1.9035022114479503, 1.8671229255586645, 1.8270364018516845, 1.784564351201145, 1.7448485512759344, 
          1.702634395430104, 1.668995241840853, 1.6452366829570217, 1.6281189152944513, 1.6141442405642739, 1.5995248288223234, 
          1.5899827210480844, 1.5773781124679243, 1.5517336978246572, 1.5292162576884887, 1.50468401439053, 1.4710932160771621, 
          1.429701099921342, 1.3902593132261352, 1.3506402238526904, 1.3104086343180616, 1.275528361981148, 1.2491586181996364, 
          1.2579915152609251, 1.2748030328429034, 1.2846191538471456, 1.2836520483294864, 1.2707573080940284, 1.2483043416590371, 
          1.2209191370839834, 1.1899717605188844, 1.1600882000232104, 1.1299145078722388, 1.1087510154607936, 1.0949214065582649, 
          1.0827681138863459, 1.0718559399620895, 1.063635543061985, 1.055737514667767, 1.0494190919523927, 1.0455506698817552, 
          1.044341787984681, 1.0434230377429046, 1.0437292878234967, 1.0464049464223544, 1.0486937628141482, 1.0547704091501076, 
          1.0609437660378331, 1.0712112029503165, 1.0814464030122113, 1.0934707482817758, 1.1056079225284006, 1.1213395056156594, 
          1.139263194542946, 1.1566872122861085, 1.1744980722363347, 1.1952424855901278, 1.217953346829828, 1.2377145362406674, 
          1.2553964487885392, 1.2901961289989812, 1.3286869286018232, 1.3719004268159019, 1.4113905687869917, 1.458440252221119]
Z_wall = [1.1857807223283445, 1.1578934642261287, 1.1411933489695416, 1.1278139130014266, 1.1020867084169548, 1.0651078817773696, 
          1.017151469722981, 0.9629889337556723, 0.9126790305550854, 0.8603380322557246, 0.8072071636401739, 0.752770591032554, 
          0.6933368796898551, 0.6384005932087273, 0.58320638988966, 0.5297208856219424, 0.474317124872049, 0.4237815444382653, 
          0.3691192945974482, 0.31305462195033495, 0.2516381749159755, 0.1939937616364824, 0.13842880286287684, 0.08270264606555933, 
          0.020996042588517838, -0.03685792812180122, -0.09253572551200517, -0.14947086748716454, -0.20592241539118727, -0.2591661226233366, 
          -0.31363493483569893, -0.35965697060554036, -0.4106761451104609, -0.46253354933868507, -0.5120858218278244, -0.5596392388229321, 
          -0.6102231786638296, -0.6520701856195243, -0.6973990698874032, -0.7418413650248648, -0.7839785284232416, -0.8236654818611924, 
          -0.862836601623264, -0.9066663442706192, -0.9577499979850247, -1.0118480547428488, -1.0642535322516946, -1.1182709899976626, 
          -1.164357504976989, -1.189875152130635, -1.1741583448186925, -1.1382756647403502, -1.102392984662008, -1.07816492169806, 
          -1.0610940509869349, -1.0543720933981349, -1.0599979044256918, -1.07144296410926, -1.0926566240297895, -1.093559332962578, 
          -1.0587889192478501, -1.0162487607901927, -0.9650845080639311, -0.9175955702783084, -0.8676403027298886, -0.8186683431261133, 
          -0.7764183411111379, -0.7302351073175843, -0.6855832547492968, -0.632452386133746, -0.5771453441980801, -0.5140363179147424, 
          -0.44699405985282614, -0.3850778989449589, -0.3271594490251549, -0.26907980108163876, -0.20859830258481027, -0.1406210959853632, 
          -0.08081662918812615, -0.021850392114192596, 0.03795407468304446, 0.1019658098991707, 0.16285030345527973, 0.22275148906674413, 
          0.289342392662266, 0.35572373882696207, 0.42089609981381626, 0.48168387455569794, 0.5435033166493379, 0.6088852350670182, 
          0.6755406178720249, 0.7329271143135785, 0.788717750320381, 0.8488768527697852, 0.9039259778675115, 0.9536233285779918, 
          0.9957604919763685, 1.0315625730428546, 1.0643180114611797, 1.0980567578241494, 1.129216335807723, 1.1683874555697948]
# AUG inner divertor
R_in = [1.24928187, 1.25037791, 1.25164662, 1.25307592, 1.25465372, 1.25636793,
        1.25820646, 1.26015722, 1.26220783, 1.26432432, 1.26643709, 1.2684732 ,
        1.27035972, 1.27204779, 1.27356159, 1.27493914, 1.27621846, 1.27743755,
        1.27861728, 1.27972182, 1.28070361, 1.28151512, 1.2821169 , 1.28252687,
        1.28278764, 1.28294196, 1.28303254, 1.28308818, 1.28309865, 1.2830469 ,
        1.28291589, 1.28268856, 1.28234789, 1.28187859, 1.2812746 , 1.28053274,
        1.27964986, 1.2786228 , 1.27744867, 1.276135  , 1.27470289, 1.27317436,
        1.27157144, 1.26991054, 1.26818273, 1.26637194, 1.26446206, 1.26243818,
        1.26029643, 1.25803897, 1.25566806, 1.2531884 , 1.25063723, 1.24807477,
        1.24556173, 1.2431587 , 1.24088867, 1.23868208, 1.23645539, 1.23412506,
        1.23161335, 1.22890566, 1.22602622, 1.22299979, 1.21985393, 1.21665898,
        1.21351899, 1.21053889, 1.20780586, 1.20524866, 1.20271309, 1.20004418,
        1.19709218, 1.19385834, 1.1905151 , 1.18724412, 1.18422655, 1.18154187,
        1.17904582, 1.1765643 , 1.17392753, 1.17107626, 1.16806833, 1.16496727,
        1.16183612, 1.15872996, 1.15569703, 1.15278535, 1.15004111, 1.14745534,
        1.14495522, 1.14246444, 1.13992525, 1.13736378, 1.13482978, 1.132373  ,
        1.13004319, 1.12789008, 1.12596345, 1.12431302]
Z_in = [-1.08698226, -1.08196971, -1.07700781, -1.07209476, -1.06722871, -1.06240785,
        -1.05763035, -1.05289438, -1.048198  , -1.0435299 , -1.03886333, -1.0341701 ,
        -1.02942201, -1.02460028, -1.01971465, -1.01478027, -1.00981228, -1.00482584,
        -0.99983182, -0.99482694, -0.98980503, -0.98475992, -0.97968661, -0.97458858,
        -0.96947299, -0.96434696, -0.95921765, -0.95409065, -0.94896713, -0.9438475 ,
        -0.93873217, -0.93362155, -0.92851607, -0.92341684, -0.91832872, -0.91325773,
        -0.90820991, -0.90319127, -0.89820775, -0.89326079, -0.88834607, -0.88345886,
        -0.87859442, -0.87374979, -0.86893001, -0.86414237, -0.85939418, -0.85469247,
        -0.85004179, -0.84544538, -0.84090641, -0.83642654, -0.83198715, -0.82755527,
        -0.82309763, -0.81858101, -0.81399271, -0.80937046, -0.80475963, -0.80020557,
        -0.79575083, -0.79140744, -0.78716867, -0.78302749, -0.77897453, -0.77496393,
        -0.77092106, -0.76677053, -0.76244948, -0.75800658, -0.75354893, -0.74918416,
        -0.7450163 , -0.7410448 , -0.73715056, -0.73320813, -0.72909236, -0.72474766,
        -0.72027146, -0.71578157, -0.71139291, -0.70714603, -0.70300264, -0.69892065,
        -0.69485832, -0.69077974, -0.68665405, -0.68245053, -0.67813961, -0.67372661,
        -0.66925716, -0.66477913, -0.66032943, -0.6558955 , -0.65145088, -0.6469691 ,
        -0.64242369, -0.63778818, -0.63303609, -0.62814097]
# AUG outer divertor 
R_out = [1.58211701, 1.58373013, 1.58522876, 1.58662408, 1.58792727, 1.58914951,
         1.59030198, 1.59139587, 1.59244236, 1.59345262, 1.59443785, 1.59540921,
         1.59637789, 1.59735404, 1.59833796, 1.59932451, 1.60030849, 1.60128472,
         1.60224816, 1.60320156, 1.60415862, 1.60513384, 1.6061417 , 1.60719629,
         1.608296  , 1.6094194 , 1.61054379, 1.61164649, 1.61270478, 1.61369639,
         1.61461937, 1.61550099, 1.6163708 , 1.61725834, 1.61819317, 1.6192048 ,
         1.62030643, 1.6214671 , 1.62264849, 1.62381228, 1.62492016, 1.62595178,
         1.62693809, 1.62791909, 1.62893481, 1.63002528, 1.63123012, 1.63256489,
         1.63400806, 1.63553491, 1.63712072, 1.63874077, 1.64037203, 1.642006  ,
         1.64364166, 1.64527805, 1.64691421, 1.64854896, 1.65017582, 1.65178259,
         1.65335681, 1.65488603, 1.65635783, 1.65777956, 1.65920642, 1.66070072,
         1.66232475, 1.66412714, 1.66609031, 1.66817673, 1.67034882, 1.67256901,
         1.67480116, 1.67704013, 1.67931122, 1.681641  , 1.68405605, 1.68658294,
         1.68924066, 1.69201572, 1.69488593, 1.69782911, 1.70082309, 1.70384595,
         1.70688438, 1.70993515, 1.7129956 , 1.71606307, 1.71913489, 1.72220864,
         1.72528362, 1.72836005, 1.73143813, 1.73451804, 1.7376    , 1.7406842 ,
         1.74377084, 1.74686013, 1.74995225, 1.75304743]
Z_out = [-1.1797302 , -1.17584427, -1.17192351, -1.16797136, -1.16399128, -1.15998669,
         -1.15596104, -1.15191777, -1.14786031, -1.14379211, -1.13971661, -1.13563724,
         -1.13155745, -1.12748036, -1.12340608, -1.11933308, -1.11525979, -1.11118464,
         -1.10710612, -1.10302482, -1.09894425, -1.09486817, -1.09080032, -1.08674434,
         -1.08269988, -1.0786615 , -1.07462347, -1.07058004, -1.06652547, -1.06245411,
         -1.05836552, -1.05426666, -1.05016509, -1.04606836, -1.04198404, -1.03791967,
         -1.03387851, -1.02985215, -1.02583029, -1.02180258, -1.01775872, -1.01369345,
         -1.00961605, -1.00553836, -1.00147223, -0.99742949, -0.99342188, -0.98945418,
         -0.9855205 , -0.981614  , -0.97772786, -0.97385526, -0.96998977, -0.96612844,
         -0.96227006, -0.95841347, -0.95455747, -0.95070083, -0.94684033, -0.94297071,
         -0.93908658, -0.93518255, -0.93125327, -0.92730239, -0.92335531, -0.91944071,
         -0.91558724, -0.91181723, -0.90812254, -0.90448578, -0.90088956, -0.8973165 ,
         -0.89375003, -0.8901916 , -0.88666037, -0.88317622, -0.87975903, -0.87642869,
         -0.87319966, -0.87006321, -0.86700441, -0.8640083 , -0.86105996, -0.85814459,
         -0.85525204, -0.85237755, -0.84951673, -0.84666513, -0.84381835, -0.84097233,
         -0.83812611, -0.83528023, -0.83243524, -0.82959169, -0.82675013, -0.82391111,
         -0.82107517, -0.81824287, -0.81541475, -0.81259136]

interp = pg.GInterpModal(psid,2,"mt")
grid, psi = interp.interpolate()
for d in range(len(grid)):
    grid[d] = 0.5*(grid[d][:-1] + grid[d][1:])

clevels = np.linspace(psi_min, psi_max, npsi)

fig, ax = plt.subplots(figsize=[4.0, 6.0])
# Plot the flux
#ax.contour(grid[0], grid[1], psi[:,:,0].transpose(), levels=clevels, colors="k")
# Plot the separatrix
cont = ax.contour(grid[0], grid[1], psi[:,:,0].transpose(), levels=np.r_[psisep], colors="r")
ax.clabel(cont, inline=1, fontsize=10)
ax.plot([], [], color="red", label="separatrix")
# Plot the first wall
ax.plot(R_wall, Z_wall, color="blue", label="first wall")
# Plot the inner and outer divertors
ax.plot(R_in, Z_in, color="green", label="divertor")
ax.plot(R_out, Z_out, color="green")

data = pg.GData(data_dir+'/'+simName+"-nodes.gkyl")
vals = data.get_values()
alpha_idx = 0
R_ind = np.arange(0, 40, 8)
R = vals[R_ind,alpha_idx,:,0]
Z = vals[R_ind,alpha_idx,:,1]
#phi = vals[:,alpha_idx:,2]
print(R[0,0], R[-1,0], R[0,-1], R[-1,-1])

#Plot all nodes and cell boundaries
ax.plot(R,Z,marker=".", color="k", linestyle="none", linewidth=0.05)
ax.scatter(R,Z, marker=".")
segs1 = np.stack((R,Z), axis=2)
segs2 = segs1.transpose(1,0,2)
ax.add_collection(LineCollection(segs1, color = "tab:blue"))
ax.add_collection(LineCollection(segs2, color = "tab:blue"))


# Horizontal divertor plates
#plt.hlines(-1.0, 1.08, 1.33, color='brown', linewidth=2.0)
#plt.hlines(-1.0, 1.50, 1.72, color='brown', linewidth=2.0, label='divertor plates')
plt.hlines(-1.0, 1.1, 1.3, color='green')
plt.hlines(-1.0, 1.54, 1.7, color='green')

# Tilted Divertor plates
#s = np.linspace(0.0, 1.0, 101)
#R_lower = 0.25*s + 1.5
#Z_lower = -0.25*s - 1.0
#R_upper = -0.32*s + 1.32
#Z_upper = -0.08*s - 1.0
#plt.plot(R_lower, Z_lower, color='brown')
#plt.plot(R_upper, Z_upper, color='brown', linewidth=2.0, label='divertor plates')


ax.set_xlim(1.00, 2.25)
ax.set_ylim(-1.25, 1.25)
ax.set_aspect('equal')
ax.set_xlabel("R(m)", fontsize=14)
ax.set_ylabel("Z(m)", fontsize=14)
ax.tick_params('both', labelsize=12)

plt.legend(fontsize=12)
plt.grid()
plt.tight_layout()
if out_figure_file:
  plt.savefig(out_figure_dir+'/'+simName+'_asdex_nodes.png')
else:
  plt.show()
